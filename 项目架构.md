# Deepfake 系统集成架构说明

## 1. 项目结构概述
本项目构建了一个完整的 AI 换脸与检测系统，核心基于 **DeepfakeBench** 框架进行扩展，并集成了 **Sber-Swap (GHOST)** 作为高性能换脸模块。

系统采用了**模块化微服务架构**思路，以解决不同算法组件之间的环境依赖冲突问题。

### 1.1 目录结构
```text
DeepfakeBench/
├── tools/                  # [核心] 系统集成与业务逻辑
│   ├── webui.py            # [入口] WebUI 主程序 (Streamlit/Gradio 或 Flask 后端)
│   ├── static/             # 前端静态资源 (JS/CSS)
│   ├── templates/          # 前端 HTML 模板
│   ├── 图像特征训练.py      # 本地实现的传统检测算法训练
│   ├── 图像特征推理.py      # 本地实现的传统检测算法推理
│   └── ...
├── sber-swap/              # [子模块] GHOST 换脸模块 (独立运行)
│   ├── api_server.py       # GHOST 的 API 服务端
│   ├── inference.py        # 换脸核心推理代码
│   └── ...
├── simswap/                # [子模块] SimSwap 换脸模块
├── training/               # DeepfakeBench 原生检测模型训练代码
└── datasets/               # 数据集存放目录 (UADFV, Celeb-DF 等)
```

## 2. 关键集成逻辑
由于 **Sber-Swap (GHOST)** 依赖的 PyTorch 版本与 DeepfakeBench 可能存在冲突（例如旧版 CUDA 依赖），本项目采用了 **API 服务调用** 的方式进行集成。

### 2.1 换脸模块 (Sber-Swap / GHOST)
*   **运行模式**: 独立运行在专有的 Conda 环境中。
*   **服务接口**: `sber-swap/api_server.py` 启动一个 HTTP 服务（默认端口 8000）。
*   **通信流程**:
    1.  主系统 (`webui.py`) 接收用户上传的 Source 和 Target 图片。
    2.  `webui.py` 将图片数据（Base64 或文件路径）发送给 `localhost:8000/swap`。
    3.  `api_server.py` 调用 GHOST 模型进行推理，返回换脸后的图片。

### 2.2 检测模块 (DeepfakeBench + Custom Features)
*   **深度学习检测**: 直接调用 DeepfakeBench 的 `training/detectors` 下的 SOTA 模型（如 Xception, EfficientNet）。
*   **图像特征检测**: 调用 `tools/图像特征推理.py`，使用 SVM 进行轻量级检测。
*   **集成位置**: 所有检测逻辑统一封装在 `webui.py` 的 `/api/detect` 接口中。

## 3. 启动与使用说明
### 3.1 启动换脸服务
由于环境隔离，需要先启动子模块服务：
```bash
# 在 sber-swap 环境下
conda activate ghost_env
cd sber-swap
python api_server.py
```

### 3.2 启动主系统 WebUI
```bash
# 在主环境下
conda activate deepfakebench
cd tools
python webui.py
```
访问浏览器（默认为 `http://localhost:5000` 或 `7860`）即可使用完整的换脸与检测功能。
